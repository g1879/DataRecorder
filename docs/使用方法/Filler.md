`Filler`专门用于处理表格文件，支持 xlsx 和 csv 两种格式。

它的用法非常灵活：

- 可指定文件单元格坐标作为左上角，写入一片一维或二维数据

- 可按条件获取列数据，并对相应列回写数据，用于记录工作状态，可实现断点续爬等功能

- 可以给单元格设置连接

# 🐘创建对象

```python
from DataRecorder import Filler

f = Filler(path='data.csv', cache_size=50)
```

初始化参数：

第二个以后的参数，都是用于实现按条件从行取数据，处理后回填的功能。后面详细说明。

- `path`：文件路径，若不存在会自动创建。

- `cache_size`：缓存数据条数，到达条数自动写入文件。为 0 时不自动写入。

- `key_cols`：作为关键字的列，可以是多列，可以接收列号数字或字母，从1开始

- `begin_row`：数据开始的行，默认表头一行，数据从第 2 行开始

- `sign_col`：用于判断是否已填数据的列，可以接收列号数字或字母，从1开始

- `data_col`：要填入数据的第一列，可以接收列号数字或字母，从1开始

- `sign`：按这个值筛选需要的行纳入`keys`

- `deny_sign`：是否反向匹配`sign`，即筛选`sign_col`列值不是`sign`的行

# ➕添加数据

`Filler`每个数据可指定坐标。如不指定，默认在文件末尾添加。

数据可以是单个数据、一维列表、二维列表。会覆盖到以坐标为左上角的区域。

坐标的指定方式非常灵活，支持多种形式，支持只指定行或列，支持从后面向前数，具体见[《进阶用法》](进阶用法.md)章节。

## ✔添加单个或一维列表数据

```python
f.add_data('abc', 'c3')  # 在c3单元格填入一个数据
f.add_data((123, 456), (4, 4))  # 在第4行第4列开始填入一行数据
```

文件内容：

|     |     |     |     |     |
| --- | --- |:---:|:---:|:---:|
|     |     |     |     |     |
|     |     | abc |     |     |
|     |     |     | 123 | 456 |

可见前两行是空行，数据从第三列第三行开始写入。

## ✔添加二维列表数据

这里继续使用刚才的文件，在刚才的基础上再填入一个二维数据。

```python
data = ((1, 2), (3, 4))
f.add_data(data, 'b2')
```

文件内容：

|     |     |     |     |     |
| --- |:---:|:---:|:---:|:---:|
|     | 1   | 2   |     |     |
|     | 3   | 4   |     |     |
|     |     |     | 123 | 456 |

可见，刚才的第二行已写入数据，第三行的 abc 已被覆盖。

## ✔不指定坐标添加数据

如添加数据时不传入坐标参数，程序会按照`data_col`值为列在文件末尾添加新行。

注：`data_col`默认是第 2 列。

这里继续用上面的文件

```python
data = ((5, 6), (7, 8))
f.add_data(data)
```

文件内容：

|     |     |     |     |     |
| --- |:---:|:---:|:---:|:---:|
|     | 1   | 2   |     |     |
|     | 3   | 4   |     |     |
|     |     |     | 123 | 456 |
|     | 5   | 6   |     |     |
|     | 7   | 8   |     |     |

除了使用`data_col`作为列外，还能在添加新行时实时设置列号。

```python
f.add_data(data, 'd')
```

指定列号字母，不指定行号，表示在新行d列插入。

# 💾写入文件

这部分内容与`Recorder`一致。同样支持自动写入和手动写入。

## ⚠️注意事项

- 如果对象为全局对象，那么在使用 xlsx 或多线程写入的时候，退出自动记录功能会报错，须显式调用`record()`方法，或把记录器声明放在一个方法内。

- 切勿在文件正在写入的时候关闭进程，以免造成文件损坏。

详见[《注意事项》](%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9.md)一节。

# 🧭灵活的坐标设置方式

`Filler`支持极其灵活的坐标设置方式，包括以下这些都是可以的：

- excel 坐标方式。如 `'A3'`。

- 行列数字组成的元组或列表。如`[2, 3]`或`(2, 3)`表示第二行第三列。

- 字母列号。如`[2, 'a']`表示第二行 A 列。

- 字符串行列号。如`'2,3'`或`'2,c'`表示第二行第三列。

- 行号为`None`或`'newline'`表示新增一行。如`(None, 3)`表示新行第三列。

- 行号和列号都支持负数，表示从后往前数。如`(-3, -3)`表示倒数第三行倒数第三列；`'a-3'`表示倒数第三行的 A 列。

在`add_data()`设置坐标时，除了设置完整坐标，还可以如下设置：

- 不传入坐标，表示新行，列号使用`data_col`参数的值。如`f.add_data(data)`表示新行`data_col`列。

- 只传入数字，表示行数，列号使用`data_col`参数的值。如`f.add_data(data, 3)`表示第三行`data_col`列。

- 只传入字母，表示列号，并新建一行。如`f.add_data(data, 'c')`表示新行 C 列。

!>**注意：**<br>负值列号要慎用，通常只用在数据不会超出最大列的情况。因为如果数据超过了最大列，保存文件后最大列的列号就会产生变化，导致错位。

# 📝任务管理功能

## 📌示例

假设现在有一个表格，里面记录着要下载的文件
url，须要设计一个程序把文件下载到指定地方，并把路径填写回相应的列，并在表格文件中设置点击即可打开的链接。在下载过程中，网络可能不稳定，有中途中断的可能性。那么如何能够方便快捷地完成上面的任务呢？

`Filler`集成了这样的功能，提供了基本的任务管理功能，下面以一个例子来说明。

任务清单文件：

| URL                                                              | 已下载 | 保存路径 |
|:----------------------------------------------------------------:|:---:|:----:|
| https://dldir1.qq.com/qqfile/qq/PCQQ9.6.1/QQ9.6.1.28732.exe      |     |      |
| https://dldir1.qq.com/qqfile/qq/TIM3.3.9/TIM3.3.9.22051.exe      |     |      |
| https://dldir1.qq.com/qqfile/QQforMac/QQ_6.7.9.21089_961_EXP.dmg |     |      |

可见表格文件里第一列是要下载的文件 url，第二列用于标记是否已下载，第三列下载后回填保存路径。

我们可以给`Filler`指定第一列为 key 列，第二列为 sign 列。程序可以根据 sign 内容判断哪些行是须要执行任务的，用`keys`
属性获取要执行的任务数据，然后把执行结果回填到 sign 列，如果中途中断了，下次执行会从sign 列为空的行继续执行。

创建对象，并把 keys 打印出来看看：

```python
from DataRecorder import Filler

f = Filler('data.csv', key_cols=1, sign_col=2)
for key in f.keys:
    print(key)
```

输出：

```console
[2, 'https://dldir1.qq.com/qqfile/qq/PCQQ9.6.1/QQ9.6.1.28732.exe']
[3, 'https://dldir1.qq.com/qqfile/qq/TIM3.3.9/TIM3.3.9.22051.exe']
[4, 'https://dldir1.qq.com/qqfile/QQforMac/QQ_6.7.9.21089_961_EXP.dmg']
```

可见`Filler`获取到 3 个任务，其中第一位的数字是该任务的行数，等下要根据这个行数给表格文件回填数据。

下面我们逐个任务执行，使用 [DownloadKit](https://gitee.com/g1879/DownloadKit) 库执行下载。

```python
from DataRecorder import Filler
from DownloadKit import DownloadKit

d = DownloadKit('files')  # 创建DownloadKit对象，指定下载路径
f = Filler('data.csv', key_cols=1, sign_col=2)
for key in f.keys:  # 遍历任务
    row, url = key
    mission = d.add(url)  # 新建下载任务
    mission.wait()  # 等待下载完成
    path = mission.path  # 获取保存路径
    f.add_data(('ok', path), row)  # 回填到表格文件
```

现在表格文件内容为：

| URL                                                              | 已下载 | 保存路径                                |
|:----------------------------------------------------------------:|:---:|:-----------------------------------:|
| https://dldir1.qq.com/qqfile/qq/PCQQ9.6.1/QQ9.6.1.28732.exe      | ok  | D:\files\QQ9.6.1.28732.exe          |
| https://dldir1.qq.com/qqfile/qq/TIM3.3.9/TIM3.3.9.22051.exe      | ok  | D:\files\TIM3.3.9.22051.exe         |
| https://dldir1.qq.com/qqfile/QQforMac/QQ_6.7.9.21089_961_EXP.dmg | ok  | D:\files\QQ_6.7.9.21089_961_EXP.dmg |

假如某种原因导致程序中断了，那未执行的行的 sign 列就不会填上`'ok'`，下次再执行程序时，会忽略已填写的行，继续执行未完成的行。从而实现任务的断点继续执行。

## 🔊更多说明

- 上面的示例中，`add_data()`第二个参数只填写了行号，那是因为设置了`data_col`属性，默认回填在`data_col`属性指定的列。

- 示例中没有显式指定`data_col`属性，是因为默认情况下与`sign_col`一致。如果不一致，可以另外指定。

- `key_cols`参数可以指定多列，传入列号组成的列表即可，列号可以用字母或数字。会返回多个 key 值（行号依然是第一位）。

- `key_cols`默认为`True`，表示获取所有列。

- 如果一行中要回填的数据不连续，那可以用多个`add_data()`方法填写，每个方法传入单元格坐标，如`add_data(data, (row, 'd')`。

- 默认情况下`sign`参数为`None`，即单元格内容为空就认为这行是未执行的。可以通过`sign`参数设置其它值。如设置`'未执行'`为标记。

- `sign_col`默认为`True`，表示不进行筛选，直接获取所有行。此时`data_col`值默认为`1`。

- `deny_sign`参数如果为`True`，表示筛选`sign_col`列值不是`sign`的行

# 🔗设置单元格链接

类似上面的示例，很多时候须要在 xlsx 文件里设置链接，`Filler`集成了该功能，用法和`add_data()`类似。

```python
f.set_link(coord='a5', link='https://www.baidu.com', content='百度')
```

这样设置即可对 A5 单元格设置指向该网址的链接，其中`content`参数是可选的。

# 🔣`Filler`对象的属性

## `path`

此属性以字符串方式返回当前记录的文件路径。可赋值设置。更改时会自动保存缓存数据到文件。

## `type`

此属性以字符串方式返回当前文件的类型。可赋值设置，即可无视文件后缀指定记录格式。

## `data`

此属性以`list`方式返回当前保存在缓存里的数据。

## `cache_size`

此属性返回缓存的大小，表示记录的条数。可赋值设置。

## `table`

此属性返回当前处理的数据表，处理 xlsx 文件时才生效。

## `key_cols`

此属性返回作为关键字的列或列的集合。列号可以是数字或字母。如`(1, 'b')`。可赋值设置。

列号可以重复，返回的 keys 内容会重复按顺序出现。

## `keys`

此属性返回一个列表，由未执行的行数据组成。每行的格式为第一位为行号，其余为 key 列的值。

如：[3, '张三', 20]

## `sign_col`

此属性返回用于判断是否已填数据的列。列号可以是数字或字母。可赋值设置。

## `data_col`

此属性返回用于填充数据的列，不设置时与`sign_col`一致。列号可以是数字或字母。可赋值设置。

## `begin_row`

此属性返回数据开始的行号（跳过表头），用于获取keys，从1开始。可赋值设置。

## `encoding`

此属性返回当前文件的编码方式，默认为`'utf-8'`，可赋值设置。

## `delimiter`

此属性返回 csv 文件使用的分隔符，默认为`','`，可赋值设置。

文件格式为 csv 时才生效。

## `quote_char`

此属性返回csv 文件使用的引用符，默认为`'"'`，可赋值设置。

文件格式为 csv 时才生效。

## `before`

此属性返回当前对象设置的 before 内容，before 内容的用法将在《进阶用法》章节说明。

## `after`

此属性返回当前对象设置的 after 内容，after 内容的用法将在《进阶用法》章节说明。

## `show_msg`

此属性用于设置是否打印程序运行时产生的提示信息。

# ♾️`Recorder`对象的方法

## `add_data()`

此方法用于添加数据到缓存，可接收一个、一维或二维数据。当接收的是二维数据时，会填充到以指定坐标为左上角的区域中。

参数：

- data：可接收任意格式，接收一维`list`、`tuple`和`dict`时记录为一行，接收二维数据时记录为多行
- coord: 要添加数据的坐标，可输入行号、列号或行列坐标，如'a3'、7、(3, 1)、[3, 1]、'c'。也可以是负数，代表从下往上数，-1是倒数第一行。为`None`时表示新增行。

返回：`None`

## `set_link()`

此方法用于为单元格设置超链接。

参数：

- coord：单元格坐标

- link：超链接

- content：单元格文本，不传入时显式超链接文本

返回：`None`

## `set_link_style()`

此方法用于设置 xlsx 文件的链接样式。

参数：

- style：openpyxl 的`Font`对象

返回：`None`

## `record()`

此方法用于把数据记录到文件，然后清空缓存。可把数据保存到一个新文件。

参数：

- new_path：保存到新文件的路径

返回：成功时以文本方式返回文件路径，失败时返回未保存的数据

## `set_path()`

此方法用于设置文件路径，更改文件路径时会自动保存已有缓存。

参数：

- `path`：文件路径，可以是`str`或`Path`对象
- `cache_size`：每接收多少条记录写入文件，传入`0`表示不自动保存
- `key_cols`：作为关键字的列，可以是多列，从1开始，`True`表示获取整行
- `begin_row`：数据开始的行，默认表头一行
- `sign_col`：用于判断是否已填数据的列，从1开始，`True`表示获取所有行
- `data_col`：要填入数据的第一列，从1开始
- `sign`：按这个值筛选需要的行纳入`keys`
- `deny_sign`：是否反向匹配`sign`，即筛选`sign_col列`值不是`sign`的行

返回：`None`

## `set_table()`

此方法用于处理 xlsx 文件时指定数据表。

参数：

- `table`：数据表名称

返回：`None`

## `clear()`

此方法用于清空现有缓存。

参数：无

返回：`None`

## `set_head()`

此方法用于给表格文件设置表头。

参数：

- head：表头，接收`list`或`tuple`

返回：`None`

## `set_before()`

此方法用于设置对象 before 内容，设置前会先保存缓存数据。

before 内容的用法将在《进阶用法》章节说明。

参数：

- before：每行数据前要添加的内容，单个数据或列表数据皆可

返回：`None`

## `set_after()`

此方法用于设置对象 after 内容，设置前会先保存缓存数据。

after 内容的用法将在《进阶用法》章节说明。

参数：

- after：每行数据后要添加的内容，单个数据或列表数据皆可

返回：`None`
